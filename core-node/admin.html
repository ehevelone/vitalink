<script>

const firebaseConfig = {
  apiKey: "YOUR_FIREBASE_API_KEY",
  authDomain: "YOUR_FIREBASE_AUTH_DOMAIN",
  projectId: "YOUR_FIREBASE_PROJECT_ID"
};

firebase.initializeApp(firebaseConfig);

let confirmationResult = null;
let currentEmail = null;

document.getElementById("loginBtn").addEventListener("click", login);
document.getElementById("verifyBtn").addEventListener("click", verifyCode);

async function login() {
  hideError();

  const email = document.getElementById("email").value.trim();
  const password = document.getElementById("password").value;

  if (!email || !password) {
    return showError("Enter email and password.");
  }

  currentEmail = email;

  try {
    const res = await fetch(
      "https://vitalink-app.netlify.app/.netlify/functions/admin-login",
      {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ email, password })
      }
    );

    if (!res.ok) {
      const t = await res.text();
      return showError(t || "Invalid credentials.");
    }

    const data = await res.json();

    if (data.step !== "firebase_2fa" || !data.phone) {
      return showError("Unexpected response.");
    }

    // Setup invisible reCAPTCHA
    window.recaptchaVerifier = new firebase.auth.RecaptchaVerifier(
      "recaptcha-container",
      { size: "invisible" }
    );

    confirmationResult = await firebase.auth().signInWithPhoneNumber(
      data.phone,
      window.recaptchaVerifier
    );

    document.getElementById("step1").classList.add("hidden");
    document.getElementById("step2").classList.remove("hidden");

  } catch (e) {
    showError("Login failed.");
  }
}

async function verifyCode() {
  hideError();

  const code = document.getElementById("smsCode").value.trim();
  if (!code) return showError("Enter the SMS code.");

  try {
    const result = await confirmationResult.confirm(code);
    const idToken = await result.user.getIdToken();

    const res = await fetch(
      "https://vitalink-app.netlify.app/.netlify/functions/admin-verify",
      {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ idToken, email: currentEmail })
      }
    );

    if (!res.ok) {
      const t = await res.text();
      return showError(t || "Verification failed.");
    }

    const data = await res.json();
    sessionStorage.setItem("adminSessionToken", data.token);

    window.location.href = "rsm_access.html";

  } catch (e) {
    showError("Invalid code.");
  }
}

function showError(msg) {
  const err = document.getElementById("error");
  err.innerText = msg;
  err.classList.remove("hidden");
}

function hideError() {
  const err = document.getElementById("error");
  err.classList.add("hidden");
  err.innerText = "";
}

</script>
